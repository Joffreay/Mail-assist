<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Authentication</title>
  <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <style>
    body { font-family: Segoe UI, Arial, sans-serif; margin: 24px; }
    .api-key-form { display: none; }
    .api-key-form.show { display: block; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 4px; font-weight: 500; }
    .form-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    .button-group { display: flex; gap: 8px; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
    .btn-primary { background-color: #0078d4; color: white; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <div id="auth-status">
    <p id="status">Authentification en cours...</p>
  </div>

  <div id="api-key-form" class="api-key-form">
    <h3>Saisir votre clé API OpenAI</h3>
    <p>Pour utiliser la fonction de réponse automatique, vous devez fournir votre clé API OpenAI.</p>
    
    <div class="form-group">
      <label for="api-key-input">Clé API OpenAI :</label>
      <input type="password" id="api-key-input" placeholder="sk-..." />
    </div>
    
    <div class="button-group">
      <button class="btn btn-primary" onclick="submitApiKey()">Valider</button>
      <button class="btn btn-secondary" onclick="cancelApiKey()">Annuler</button>
    </div>
  </div>

  <script>
    window.Office = window.Office || {};
    Office.initialize = Office.initialize || function () {};

    // Fonctions pour la gestion de la clé API
    function submitApiKey() {
      const apiKey = document.getElementById('api-key-input').value.trim();
      if (!apiKey) {
        alert('Veuillez saisir une clé API valide.');
        return;
      }
      
      try {
        Office.context.ui.messageParent(JSON.stringify({ 
          type: "api_key", 
          apiKey: apiKey 
        }));
      } catch (e) {
        console.error('Erreur lors de l\'envoi de la clé API:', e);
      }
    }

    function cancelApiKey() {
      try {
        Office.context.ui.messageParent(JSON.stringify({ 
          type: "cancel" 
        }));
      } catch (e) {
        console.error('Erreur lors de l\'annulation:', e);
      }
    }

    (async () => {
      try {
        const params = new URLSearchParams(location.search);
        const prompt = params.get("prompt");
        
        // Si c'est une demande de clé API, afficher le formulaire
        if (prompt === "api_key") {
          document.getElementById('auth-status').style.display = 'none';
          document.getElementById('api-key-form').classList.add('show');
          return;
        }

        // Sinon, procéder avec l'authentification MSAL normale
        let clientId = params.get("clientId");
        if (!clientId) {
          const hashParams = new URLSearchParams(location.hash?.replace(/^#/, ""));
          clientId = hashParams.get("cid") || clientId;
        }
        if (!clientId) {
          try { clientId = localStorage.getItem("msal_client_id") || ""; } catch {}
        }
        if (!clientId) {
          try { Office.context.ui.messageParent(JSON.stringify({ type: "error", error: "Client ID manquant" })); } catch {}
          return;
        }
        
        const msalInstance = new msal.PublicClientApplication({
          auth: {
            clientId,
            redirectUri: `${location.origin}/auth.html`,
            navigateToLoginRequestUrl: false,
          },
          cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: true },
          system: { allowRedirectInIframe: true },
          loggerOptions: {
            loggerCallback: (level, message, containsPii) => {
              if (/error|warn/i.test(message)) { try { document.getElementById("status").textContent = message; } catch {} }
            },
            logLevel: msal.LogLevel.Warning,
            piiLoggingEnabled: false,
          },
        });
        
        const scopes = ["User.Read", "Calendars.Read"];
        const setStatus = (t) => { try { document.getElementById("status").textContent = t; } catch {} };

        setStatus("Traitement du résultat d'authentification...");
        const redirectResult = await msalInstance.handleRedirectPromise();
        let account = redirectResult?.account || msalInstance.getAllAccounts()[0];
        if (!account) {
          setStatus("Ouverture de la fenêtre de connexion...");
          const loginResp = await msalInstance.loginPopup({ scopes }).catch(async () => {
            setStatus("Connexion par redirection...");
            await msalInstance.loginRedirect({ scopes });
            return null;
          });
          if (!loginResp) return;
          account = loginResp.account || msalInstance.getAllAccounts()[0];
        }
        setStatus("Récupération du jeton...");
        const tokenResult = await msalInstance.acquireTokenSilent({ scopes, account }).catch(async (err) => {
          if (err && (err.errorCode === "interaction_required" || err.errorCode === "login_required" || err.errorCode === "consent_required")) {
            setStatus("Consent/interaction requis, ouverture d'une fenêtre...");
            const r = await msalInstance.acquireTokenPopup({ scopes }).catch(async () => {
              setStatus("Consent par redirection...");
              await msalInstance.acquireTokenRedirect({ scopes });
              return null;
            });
            return r;
          }
          throw err;
        });
        if (!tokenResult) return;
        setStatus("Envoi du jeton à l'add-in...");
        const payload = JSON.stringify({ type: "token", token: tokenResult.accessToken });
        const start = Date.now();
        const trySend = () => {
          try { if (window.Office?.context?.ui?.messageParent) { Office.context.ui.messageParent(payload); return true; } } catch {}
          return false;
        };
        if (!trySend()) {
          const timer = setInterval(() => {
            if (trySend() || Date.now() - start > 30000) { clearInterval(timer); try { window.close(); } catch {} }
          }, 200);
        } else {
          try { window.close(); } catch {}
        }
      } catch (e) {
        const msg = e && e.message ? e.message : String(e);
        try { document.getElementById("status").textContent = `Erreur: ${msg}`; } catch {}
        try { Office.context.ui.messageParent(JSON.stringify({ type: "error", error: msg })); } catch {}
      }
    })();
  </script>
</body>
</html>


